name: Deploy Discord Bot

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'develop'
        type: string

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # OIDC 권한 설정
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-DeployDiscordBot
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy via SSM Run Command
        id: deploy
        run: |
          BRANCH="${{ github.event.inputs.branch || 'develop' }}"
          
          echo "Deploying discord-bot (branch: $BRANCH) to EC2..."
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "KookminFeed-DeployApplication" \
            --parameters "service=discord-bot,branch=$BRANCH" \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          
          # Wait for command completion
          echo "Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"
      
      - name: Get deployment result
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command_id }}"
          
          echo "Getting deployment result..."
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query 'Status' \
            --output text)
          
          echo "Deployment status: $RESULT"
          
          if [ "$RESULT" = "Success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed!"
            # Get error details
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi
      
      - name: Get deployment logs
        if: always()
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command_id }}"
          
          echo "=== Deployment Logs ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text
